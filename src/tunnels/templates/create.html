{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/xterm@3.6.0/dist/xterm.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css">
<style>
.embedded-terminal {
  background-color: #000;
  border-radius: 8px;
}
.language-bash {
  border-radius: 8px !important;
  border: 1px solid #4a5568 !important;
}

/* Connection Status Light Styles */
.connection-light {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  position: relative;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

.connection-light.disconnected {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  animation: pulse-red 2s infinite;
}

.connection-light.connected {
  background: linear-gradient(135deg, #10b981, #059669);
  animation: pulse-green 2s infinite;
}

.connection-light.connecting {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  animation: pulse-yellow 1s infinite;
}

.connection-light::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  transition: all 0.3s ease;
}

.connection-light.connected::before {
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
}

@keyframes pulse-red {
  0%, 100% { 
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4), 0 0 20px rgba(239, 68, 68, 0.3);
  }
  50% { 
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6), 0 0 30px rgba(239, 68, 68, 0.5);
  }
}

@keyframes pulse-green {
  0%, 100% { 
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4), 0 0 20px rgba(16, 185, 129, 0.3);
  }
  50% { 
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6), 0 0 30px rgba(16, 185, 129, 0.5);
  }
}

@keyframes pulse-yellow {
  0%, 100% { 
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4), 0 0 20px rgba(245, 158, 11, 0.3);
  }
  50% { 
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6), 0 0 30px rgba(245, 158, 11, 0.5);
  }
}
</style>
{% endblock %}

{% block title %}Create Reverse Tunnels{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  <!-- Header Section -->
  <div class="text-center mb-4">
    <div class="d-flex justify-content-center mb-3">
      <div class="page-icon d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 20px; box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);">
        <i class="fas fa-plus text-white" style="font-size: 1.5rem;"></i>
      </div>
    </div>
    <h1 class="h2 fw-bold text-dark mb-2">Create New Tunnel</h1>
    <p class="text-muted">Set up a reverse SSH tunnel connection</p>
  </div>

  <!-- Step Indicator -->
  <div class="step-indicator">
    <div class="step-item">
      <div class="step-number active" id="stepNumber1">1</div>
      <div class="step-connector" id="stepConnector1"></div>
      <div class="step-content">
        <div class="step-label active" id="stepLabel1">Basic Info</div>
        <div class="step-description">Tunnel configuration</div>
      </div>
    </div>
    <div class="step-item">
      <div class="step-number pending" id="stepNumber2">2</div>
      <div class="step-connector" id="stepConnector2"></div>
      <div class="step-content">
        <div class="step-label" id="stepLabel2">Server Keys</div>
        <div class="step-description">Add SSH keys</div>
      </div>
    </div>
    <div class="step-item">
      <div class="step-number pending" id="stepNumber3">3</div>
      <div class="step-connector" id="stepConnector3"></div>
      <div class="step-content">
        <div class="step-label" id="stepLabel3">Manage Users</div>
        <div class="step-description">Setup user access</div>
      </div>
    </div>
    <div class="step-item">
      <div class="step-number pending" id="stepNumber4">4</div>
      <div class="step-connector" id="stepConnector4"></div>
      <div class="step-content">
        <div class="step-label" id="stepLabel4">Test Connection</div>
        <div class="step-description">Verify tunnel</div>
      </div>
    </div>
    <div class="step-item">
      <div class="step-number pending" id="stepNumber5">5</div>
      <div class="step-content">
        <div class="step-label" id="stepLabel5">Complete</div>
        <div class="step-description">Setup finished</div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Step 1: Basic Configuration -->
      <div class="card border-0 shadow-sm mb-5 fade-in" id="step1Section" style="border-radius: 20px; overflow: hidden;">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex align-items-center">
            <div class="step-icon me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 12px;">
              <i class="fas fa-cog text-white"></i>
            </div>
            <div>
              <h4 class="card-title mb-1 fw-bold">Step 1: Basic Configuration</h4>
              <p class="text-muted mb-0 small">Configure your tunnel connection details</p>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <form id="createTunnelForm">
            <div class="mb-4">
              <label for="hostFriendlyName" class="form-label">Customized Host Name</label>
              <input type="text" class="form-control" id="hostFriendlyName" placeholder="Enter Customized Host Name">
              <small class="form-text text-muted">Enter the customized name of your server.</small>
            </div>
            
            <div class="mb-4">
              <label for="key" class="form-label">Target Server SSH Public Key</label>
              <textarea class="form-control" id="key" rows="3" placeholder="Paste your target server's public SSH key here"></textarea>
              <small class="form-text text-muted">This is the public key of the server you want to connect to. Telepy will use this key to authenticate with your target server.</small>
              <div id="keyFeedback" class="invalid-feedback mt-2"></div>
            </div>
            
            <div class="mb-4">
              <label for="sshPort" class="form-label">
                <i class="fas fa-network-wired me-2"></i>SSH Port
              </label>
              <input type="number" class="form-control" id="sshPort" value="22" min="1" max="65535">
              <small class="form-text text-muted">Enter your server's SSH port. Default is 22.</small>
            </div>
            
            <div class="mb-4">
              <label for="token" class="form-label">Token</label>
              <input type="text" class="form-control" id="token" readonly>
              <small class="form-text text-muted">This token is required to create a tunnel. It will be generated automatically.</small>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-custom" id="createTunnelBtn">
                <i class="fas fa-arrow-right me-2"></i>Continue to Server Keys
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Step 2: Server Keys -->
      <div class="card border-0 shadow-sm mb-5 fade-in" id="step2Section" style="display: none; border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex align-items-center">
            <div class="step-icon me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: #ea580c; border-radius: 12px;">
              <i class="fas fa-key text-white"></i>
            </div>
            <div>
              <h4 class="card-title mb-1 fw-bold">Step 2: Add Server Keys</h4>
              <p class="text-muted mb-0 small">Configure SSH keys for secure connection</p>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="alert alert-info border-0" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 12px;">
            <div class="d-flex align-items-start">
              <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
              <div>
                <h6 class="fw-bold mb-2">About SSH Keys</h6>
                <p class="mb-0 small">Add the following keys to your server's <code>~/.ssh/authorized_keys</code> file to allow secure connections.</p>
              </div>
            </div>
          </div>

          <ul class="nav nav-tabs" id="keyTab" role="tablist" style="border: none;">
            <li class="nav-item" role="presentation">
              <button class="tab-link active" id="userKeyTab" data-bs-toggle="tab" data-bs-target="#userKeyContent" type="button" role="tab" aria-controls="user-key" aria-selected="true">
                <i class="fas fa-user me-2"></i>User Keys
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="tab-link" id="serviceKeyTab" data-bs-toggle="tab" data-bs-target="#serviceKeyContent" type="button" role="tab" aria-controls="service-key" aria-selected="false">
                <i class="fas fa-server me-2"></i>Service Keys
              </button>
            </li>
          </ul>

          <div class="tab-content mt-3" id="keyTabContent">
            <div class="tab-pane fade show active" id="userKeyContent" role="tabpanel" aria-labelledby="user-key-tab">
              <p class="text-muted mb-3">User keys are used for personal tunnel connections. You can manage them in the <strong>Keys</strong> section.</p>
              <div id="userKeys" class="mt-2"></div>
            </div>
            <div class="tab-pane fade" id="serviceKeyContent" role="tabpanel" aria-labelledby="service-key-tab">
              <p class="text-muted mb-3">Service keys are used for web terminal and automated services.</p>
              <div id="serviceKeys" class="mt-2"></div>
            </div>
          </div>
          <div class="d-grid gap-2 mt-4">
            <button class="btn btn-custom" id="keysAddedBtn">
              <i class="fas fa-check me-2"></i>Keys Added, Continue
            </button>
            <button class="btn btn-outline-warning" id="skipServiceKeyBtn" type="button">
              <i class="fas fa-exclamation-triangle me-2"></i>Skip Service Key (Web Terminal Disabled)
            </button>
          </div>
          <div class="alert alert-warning border-0 mt-3" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-radius: 12px;">
            <div class="d-flex align-items-start">
              <i class="fas fa-info-circle text-warning me-3 mt-1"></i>
              <div>
                <h6 class="fw-bold mb-2">About Service Keys</h6>
                <p class="mb-0 small">Service keys are required for web terminal functionality. If you skip adding them now, you can add them later from the Keys management page, but web terminal will be disabled until then.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Manage Users -->
      <div class="card border-0 shadow-sm mb-5 fade-in" id="step3Section" style="display: none; border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex align-items-center">
            <div class="step-icon me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: #16a34a; border-radius: 12px;">
              <i class="fas fa-users text-white"></i>
            </div>
            <div>
              <h4 class="card-title mb-1 fw-bold">Step 3: Manage Users</h4>
              <p class="text-muted mb-0 small">Setup user access for the tunnel machine</p>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="alert alert-info border-0" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 12px;">
            <div class="d-flex align-items-start">
              <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
              <div>
                <h6 class="fw-bold mb-2">Target Server Users</h6>
                <p class="mb-0 small">Add users who exist on your <strong>target server</strong> (the machine you want to connect to). These are the actual user accounts on that server that will be able to access the tunnel.</p>
              </div>
            </div>
          </div>
          
          <div id="userManagementSection">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold mb-0">Current Users</h6>
            </div>
            <div id="usersList" class="mb-4">
              <!-- User list will be populated here -->
            </div>
            <div class="input-group mb-3">
              <input type="text" class="form-control" placeholder="Username" id="newUsername">
              <button class="btn btn-outline-primary" type="button" id="addUserToListBtn">
                <i class="fas fa-plus me-2"></i>Add
              </button>
            </div>
          </div>
          
          <div class="d-grid">
            <button class="btn btn-custom" id="usersConfiguredBtn">
              <i class="fas fa-arrow-right me-2"></i>Continue to Test Connection
            </button>
            <p class="text-muted small text-center mt-2 mb-0">
              <i class="fas fa-info-circle me-1"></i>At least one user must be added to proceed
            </p>
          </div>
        </div>
      </div>

      <!-- Step 4: Test Connection -->
      <div class="card border-0 shadow-sm mb-5 fade-in" id="step4Section" style="display: none; border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex align-items-center">
            <div class="step-icon me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: #7c3aed; border-radius: 12px;">
              <i class="fas fa-terminal text-white"></i>
            </div>
            <div>
              <h4 class="card-title mb-1 fw-bold">Step 4: Test Connection</h4>
              <p class="text-muted mb-0 small">Verify your tunnel connection is working</p>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="alert alert-info border-0" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 12px;">
            <div class="d-flex align-items-start">
              <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
              <div>
                <h6 class="fw-bold mb-2">Important: Server-Side Script</h6>
                <p class="mb-0 small">The scripts below are for your <strong>target server</strong> (the machine you want to connect to). You need to run one of these scripts on that server to establish the reverse tunnel connection to Telepy.</p>
              </div>
            </div>
          </div>
          
          <div class="alert alert-warning border-0" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-radius: 12px;">
            <div class="d-flex align-items-start">
              <i class="fas fa-exclamation-triangle text-warning me-3 mt-1"></i>
              <div>
                <h6 class="fw-bold mb-2">SSH Key Setup Required</h6>
                <p class="mb-0 small">Before running the script, make sure you've added the Telepy public key to your server's <code>~/.ssh/authorized_keys</code> file (from Step 2). This allows Telepy to connect to your server.</p>
              </div>
            </div>
          </div>
          
          <!-- Script Configuration Section -->
          <div class="mb-4">
            <h6 class="fw-bold mb-3">Script Configuration</h6>
            <p class="text-muted small mb-3">Verify and adjust the connection parameters before generating the script:</p>
            
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="step4SshPort" class="form-label">
                  <i class="fas fa-network-wired me-2 text-primary"></i>SSH Port
                </label>
                <input type="number" class="form-control" id="step4SshPort" value="22" min="1" max="65535">
                <small class="form-text text-muted">Confirm your server's SSH port (default: 22)</small>
              </div>
              <div class="col-md-6">
                <label for="sshKeyPath" class="form-label">
                  <i class="fas fa-key me-2 text-warning"></i>SSH Key Path (Optional)
                </label>
                <input type="text" class="form-control" id="sshKeyPath" placeholder="e.g., ~/.ssh/id_rsa">
                <small class="form-text text-muted">Specify custom SSH key location if needed</small>
              </div>
            </div>
            
            <div class="alert alert-info border-0 mb-3" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 12px;">
              <div class="d-flex align-items-start">
                <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
                <div>
                  <h6 class="fw-bold mb-2">Configuration Tips</h6>
                  <ul class="mb-0 small">
                    <li><strong>SSH Port:</strong> Most servers use port 22. Check your server configuration if unsure.</li>
                    <li><strong>SSH Key:</strong> Leave blank to use default key (~/.ssh/id_rsa). Specify path for custom keys.</li>
                    <li><strong>Script Update:</strong> The script will automatically update when you change these values.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Connection Script Section -->
          <div class="mb-4">
            <h6 class="fw-bold mb-3">Connection Script</h6>
            <p class="text-muted small mb-3">Execute this script on your target server to create the tunnel:</p>
            
            <!-- Script Type Tabs -->
            <ul class="nav nav-tabs mb-3" id="scriptTypeTab" role="tablist" style="border: none;">
              <li class="nav-item" role="presentation">
                <button class="tab-link active" id="sshTab" data-bs-toggle="tab" data-bs-target="#sshContent" type="button" role="tab" aria-controls="ssh" aria-selected="true">
                  <i class="fas fa-terminal me-2"></i>SSH
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="tab-link" id="autosshTab" data-bs-toggle="tab" data-bs-target="#autosshContent" type="button" role="tab" aria-controls="autossh" aria-selected="false">
                  <i class="fas fa-sync-alt me-2"></i>AutoSSH
                </button>
              </li>

            </ul>
            
            <div class="tab-content" id="scriptTypeTabContent">
              <div class="tab-pane fade show active" id="sshContent" role="tabpanel" aria-labelledby="ssh-tab">
                <div class="position-relative">
                  <pre id="sshScript" class="form-control language-bash" style="height: 150px; font-family: 'Courier New', monospace; background-color: #2d3748; color: #e2e8f0; padding: 15px;" readonly>Loading SSH script...</pre>
                  <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2" onclick="copySshScript()">
                    <i class="fas fa-copy me-1"></i>Copy
                  </button>
                </div>
              </div>
              <div class="tab-pane fade" id="autosshContent" role="tabpanel" aria-labelledby="autossh-tab">
                <div class="position-relative">
                  <pre id="autosshScript" class="form-control language-bash" style="height: 150px; font-family: 'Courier New', monospace; background-color: #2d3748; color: #e2e8f0; padding: 15px;" readonly>Loading AutoSSH script...</pre>
                  <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2" onclick="copyAutosshScript()">
                    <i class="fas fa-copy me-1"></i>Copy
                  </button>
                </div>
              </div>

            </div>
          </div>
          
          <!-- Connection Status Section -->
          <div class="mb-4">
            <h6 class="fw-bold mb-3">Connection Status</h6>
            <p class="text-muted small mb-3">The system will automatically detect when your server connects using the script above:</p>
            
            <!-- Connection Status Indicator -->
            <div class="card border-0 shadow-sm" style="border-radius: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));">
              <div class="card-body p-4 text-center">
                <div class="d-flex justify-content-center align-items-center gap-3 mb-2">
                  <span id="connectionStatusBadge" class="tunnel-status disconnected"></span>
                  <h5 id="connectionStatusText" class="fw-bold mb-0 text-muted">Waiting for Connection...</h5>
                </div>
                <p id="connectionStatusDetail" class="text-muted mb-0 small">
                  Run the script on your target server to establish the tunnel connection.
                </p>
              </div>
            </div>
            
            <!-- Status Messages -->
            <div class="alert alert-info border-0 mt-3" id="statusHelpMessage" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 12px;">
              <div class="d-flex align-items-start">
                <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
                <div>
                  <h6 class="fw-bold mb-2">Testing Not Required</h6>
                  <p class="mb-0 small">If you prefer not to test the connection now, you can proceed to complete the setup. You can always test the connection later using the scripts available on the main tunnels page.</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="d-grid">
            <button class="btn btn-custom" id="nextStepBtn">
              <i class="fas fa-arrow-right me-2"></i>Next
            </button>
          </div>
        </div>
      </div>

      <!-- Step 5: Completion -->
      <div class="card border-0 shadow-sm mb-5 fade-in" id="step5Section" style="display: none; border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex align-items-center justify-content-center">
            <div class="step-icon me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: #16a34a; border-radius: 12px;">
              <i class="fas fa-check text-white" style="font-size: 1.5rem;"></i>
            </div>
          </div>
        </div>
        <div class="card-body p-4 text-center">
          <h3 class="card-title fw-bold text-success mb-3">
            <i class="fas fa-party-horn me-2"></i>Tunnel Setup Complete!
          </h3>
          <p class="card-text text-muted mb-4">Your reverse SSH tunnel has been successfully created and verified. You can now use it to connect to your remote server.</p>
          
          <!-- Terminal Configuration -->
          <div class="mb-4 text-start">
            <h6 class="fw-bold mb-3">Terminal Configuration</h6>
            <p class="text-muted small mb-3">Use this configuration to access your tunnel via terminal:</p>
            <div class="position-relative">
              <pre id="terminalConfig" class="form-control text-start" style="height: 200px; font-family: 'Courier New', monospace; background-color: #f8f9fa;" readonly>Loading configuration...</pre>
              <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2" onclick="copyTerminalConfig()">
                <i class="fas fa-copy me-1"></i>Copy
              </button>
            </div>
          </div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <button class="btn btn-outline-secondary w-100" id="createAnotherBtn">
                <i class="fas fa-plus me-2"></i>Create Another Tunnel
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-custom w-100" id="goToIndexBtn">
                <i class="fas fa-list me-2"></i>View All Tunnels
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Key Modal -->
<div class="modal fade" id="keyModal" tabindex="-1" aria-labelledby="keyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="keyModalLabel">Key Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="modalKeyContent" class="form-control" rows="5" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-custom" onclick="copyKeyToClipboard()">Copy</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% load static %}
<script src="https://unpkg.com/xterm@3.6.0/dist/xterm.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/fit/fit.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/fullscreen/fullscreen.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.11.0/src/sha256.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="{% static 'js/create.js' %}"></script>
{% endblock %}
